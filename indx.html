<!DOCTYPE html>
<!-- v3.0 -->
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MOOD</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=DM+Serif+Display:ital@0;1&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5eff4;
  --surface: #ffffff;
  --border: rgba(180,150,170,0.18);
  --text: #3a2e3a;
  --sub: rgba(90,70,90,0.5);
  --accent: #c07fa0;
  --accent2: #8aafc7;
  --r: 16px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Noto Sans JP',sans-serif;
  background:var(--bg); color:var(--text);
  min-height:100vh; overflow-x:hidden;
}
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:999; opacity:.4;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.03'/%3E%3C/svg%3E");
}

/* NAV */
nav { display:flex; background:var(--surface); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(180,140,170,.1); }
nav button {
  flex:1; padding:13px 4px; background:none; border:none; color:var(--sub);
  font-family:'Space Mono',monospace; font-size:10px; cursor:pointer;
  letter-spacing:.04em; transition:all .2s; border-bottom:2px solid transparent;
}
nav button.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:700; }

/* PAGES */
.page { display:none; padding:20px; max-width:480px; margin:0 auto; }
.page.active { display:block; }

/* HEADER */
.hdr { padding:24px 20px 0; text-align:center; }
.hdr h1 { font-family:'DM Serif Display',serif; font-size:40px; letter-spacing:-1px; color:var(--accent); }
.hdr .sub { font-size:11px; color:var(--sub); margin-top:3px; font-family:'Space Mono',monospace; }

/* CARD */
.card { background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:20px; margin-bottom:14px; }
.slbl { font-family:'Space Mono',monospace; font-size:10px; color:var(--sub); letter-spacing:.15em; text-transform:uppercase; margin-bottom:12px; }

/* DATE PICKER */
.dpick { display:flex; gap:8px; align-items:center; }
.dbtn {
  background:#fdf8fc; border:1px solid rgba(192,127,160,.25); border-radius:9px;
  padding:8px 14px; color:var(--sub); font-family:'Space Mono',monospace; font-size:11px;
  cursor:pointer; transition:all .15s; white-space:nowrap;
}
.dbtn:hover { border-color:rgba(192,127,160,.4); color:var(--text); }
.dbtn.active { background:var(--accent); border-color:var(--accent); color:#fff; font-weight:700; }
.dnative {
  flex:1; background:#fdf8fc; border:1px solid rgba(192,127,160,.25); border-radius:9px;
  padding:8px 10px; color:var(--text); font-family:'Space Mono',monospace; font-size:11px; outline:none;
}
.dnative::-webkit-calendar-picker-indicator { filter:invert(.55); cursor:pointer; }
.dnative:focus { border-color:var(--accent); }
.dsel { font-family:'Space Mono',monospace; font-size:11px; color:var(--accent); margin-top:9px; text-align:center; opacity:.85; }

/* SLIDER */
.mdisp { text-align:center; margin-bottom:20px; }
.mval { font-family:'DM Serif Display',serif; font-size:68px; line-height:1; transition:color .15s; }
.mlbl { font-size:13px; color:var(--sub); margin-top:5px; min-height:20px; }
.mtrack {
  height:48px; background:linear-gradient(to right,#8aafc7,#c9a8c0 50%,#e8879a);
  border-radius:24px; position:relative; cursor:pointer; user-select:none; margin-bottom:8px;
}
.mthumb {
  width:44px; height:44px; background:#fff; border:3px solid var(--accent); border-radius:50%;
  position:absolute; top:2px; transform:translateX(-50%);
  display:flex; align-items:center; justify-content:center;
  font-family:'Space Mono',monospace; font-size:11px; font-weight:700;
  cursor:grab; box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.mthumb:active { cursor:grabbing; }
.slabels { display:flex; justify-content:space-between; font-size:10px; color:var(--sub); font-family:'Space Mono',monospace; }

/* NOTE */
.notefield {
  width:100%; background:#fdf8fc; border:1px solid rgba(192,127,160,.25);
  border-radius:9px; padding:13px; color:var(--text); font-family:'Noto Sans JP',sans-serif;
  font-size:14px; resize:none; outline:none; line-height:1.6; min-height:76px;
}
.notefield:focus { border-color:var(--accent); }
.notefield::placeholder { color:var(--sub); }

/* CHECKLIST */
.cklist { display:flex; flex-direction:column; gap:3px; margin-bottom:12px; }
.ckitem {
  display:flex; align-items:center; gap:10px; padding:9px 10px;
  border-radius:9px; cursor:pointer; transition:background .12s; user-select:none;
}
.ckitem:hover { background:rgba(192,127,160,.08); }
.ckitem.on { background:rgba(192,127,160,.12); }
.ckemoji { font-size:20px; width:28px; text-align:center; flex-shrink:0; }
.ckbox {
  width:22px; height:22px; border:2px solid rgba(192,127,160,.35); border-radius:6px;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
  font-size:13px; transition:all .12s;
}
.ckitem.on .ckbox { background:var(--accent); border-color:var(--accent); color:#fff; }
.cklbl { flex:1; font-size:14px; color:var(--text); transition:color .12s; }
.ckitem.on .cklbl { color:var(--text); }
.ckdel { background:none; border:none; color:rgba(192,127,160,.45); font-size:16px; cursor:pointer; padding:0 2px; transition:color .15s; }
.ckdel:hover { color:rgba(255,100,80,.8); }
.ckadd { display:flex; gap:8px; }
.ckaddinput {
  flex:1; background:#fdf8fc; border:1px solid rgba(192,127,160,.25);
  border-radius:9px; padding:10px 13px; color:var(--text);
  font-family:'Noto Sans JP',sans-serif; font-size:13px; outline:none;
}
.ckaddinput:focus { border-color:var(--accent); }
.ckaddinput::placeholder { color:var(--sub); }
.ckaddbtn {
  background:rgba(192,127,160,.1); border:1px solid rgba(192,127,160,.25); border-radius:9px;
  padding:10px 15px; color:var(--text); font-size:18px; cursor:pointer; transition:all .15s; line-height:1;
}
.ckaddbtn:hover { background:var(--accent); border-color:var(--accent); color:#fff; }

/* SAVE BTN */
.savebtn {
  width:100%; padding:15px; background:var(--accent); border:none; border-radius:11px;
  color:#fff; font-family:'Space Mono',monospace; font-size:14px; font-weight:700;
  cursor:pointer; letter-spacing:.04em; transition:all .2s; margin-top:4px;
}
.savebtn:hover { filter:brightness(1.1); transform:translateY(-1px); }
.savebtn:active { transform:translateY(0); }

/* ===== STAMP CARD ===== */
.stamp-header-row {
  display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;
}
.stamp-card-label {
  font-family:'DM Serif Display',serif; font-size:22px;
}
.stamp-card-sub {
  font-family:'Space Mono',monospace; font-size:10px; color:var(--sub); margin-top:2px;
}
.stamp-progress {
  font-family:'Space Mono',monospace; font-size:12px; color:var(--accent2); font-weight:700;
}

/* 10√ó10 grid */
.stamp-grid {
  display:grid;
  grid-template-columns:repeat(10,1fr);
  gap:3px;
  margin-bottom:6px;
}
.stamp-cell {
  aspect-ratio:1;
  background:rgba(192,127,160,.07);
  border:1.5px solid rgba(192,127,160,.18);
  border-radius:6px;
  display:flex; align-items:center; justify-content:center;
  font-size:clamp(11px,2.8vw,20px);
  position:relative;
  overflow:hidden;
  transition:transform .15s;
}
.stamp-cell.filled {
  background:rgba(192,127,160,.14);
  border-color:rgba(192,127,160,.35);
}
.stamp-cell.new-stamp { animation:stampBounce .35s cubic-bezier(.34,1.56,.64,1); }

@keyframes stampBounce {
  from { transform:scale(.3); opacity:0; }
  to   { transform:scale(1);  opacity:1; }
}
/* milestone number overlay inside 10th cell */
.stamp-cell.milestone {
  position:relative;
}
.stamp-cell.milestone::after {
  content: attr(data-num);
  position:absolute;
  bottom:2px; right:3px;
  font-family:'Space Mono',monospace;
  font-size:7px;
  font-weight:700;
  color:var(--accent);
  opacity:0.7;
  line-height:1;
  pointer-events:none;
}
.stamp-cell.milestone.filled::after {
  color:#fff;
  opacity:0.85;
}

/* past cards */
.past-card-list { display:flex; flex-direction:column; gap:10px; }
.past-card-item {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--r);
  padding:16px 18px; cursor:pointer; transition:border-color .15s;
}
.past-card-item:hover { border-color:var(--accent); }
.past-card-title { font-family:'DM Serif Display',serif; font-size:18px; margin-bottom:4px; }
.past-card-meta { font-family:'Space Mono',monospace; font-size:10px; color:var(--sub); }
.past-card-preview { margin-top:8px; font-size:18px; letter-spacing:1px; }

/* modal for past card */
.modal-backdrop {
  position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:500;
  display:flex; align-items:center; justify-content:center; padding:20px;
}
.modal {
  background:#fff; border:1px solid rgba(192,127,160,.25); border-radius:var(--r);
  padding:20px; width:100%; max-width:440px; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(192,127,160,.25);
}
.modal-close {
  width:100%; padding:12px; background:rgba(255,255,255,.08); border:1px solid var(--border);
  border-radius:9px; color:var(--text); font-family:'Space Mono',monospace; font-size:12px;
  cursor:pointer; margin-top:16px; transition:background .15s;
}
.modal-close:hover { background:rgba(255,255,255,.14); }

/* GRAPH */
.gcontainer { background:var(--surface); border:1px solid var(--border); border-radius:var(--r); padding:18px; margin-bottom:14px; box-shadow:0 2px 12px rgba(180,140,170,.08); }
.period-btns { display:flex; gap:8px; margin-bottom:14px; }
.pbtn {
  padding:6px 13px; background:none; border:1px solid var(--border); border-radius:18px;
  color:var(--sub); font-family:'Space Mono',monospace; font-size:11px; cursor:pointer; transition:all .15s;
}
.pbtn.active { background:var(--accent); border-color:var(--accent); color:#fff; }
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:11px; padding:15px; text-align:center; }
.stat-val { font-family:'DM Serif Display',serif; font-size:30px; display:block; }
.stat-desc { font-size:10px; color:var(--sub); font-family:'Space Mono',monospace; margin-top:3px; }
.canvas-wrap { width:100%; position:relative; }
#moodChart { width:100%!important; display:block; }
#chart-tooltip {
  position:absolute; background:#fff; border:1px solid rgba(192,127,160,.3); color:var(--text);
  border-radius:9px; padding:7px 12px; pointer-events:none; z-index:50;
  white-space:nowrap; display:none; transform:translateX(-50%); box-shadow:0 4px 16px rgba(192,127,160,.2);
}
.barrow { display:flex; align-items:center; gap:8px; margin:2px 0; }
.barrow .bl { width:28px; text-align:right; font-size:10px; font-family:'Space Mono',monospace; color:var(--sub); }
.barbg { flex:1; height:6px; background:rgba(192,127,160,.1); border-radius:3px; overflow:hidden; }
.barfill { height:100%; border-radius:3px; transition:width .5s ease; }
.barcnt { width:22px; font-size:10px; font-family:'Space Mono',monospace; color:var(--sub); }

/* HISTORY */
.hlist { display:flex; flex-direction:column; gap:10px; }
.hitem {
  background:var(--surface); border:1px solid var(--border); border-radius:11px;
  padding:14px; display:flex; align-items:center; gap:13px; cursor:pointer; transition:border-color .15s;
}
.hitem:hover { border-color:var(--accent); }
.hscore { font-family:'DM Serif Display',serif; font-size:30px; min-width:50px; text-align:center; }
.hinfo { flex:1; min-width:0; }
.hdate { font-size:11px; color:var(--sub); font-family:'Space Mono',monospace; margin-bottom:3px; }
.hnote { font-size:13px; color:rgba(60,46,58,.7); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.hbadge { font-size:10px; font-family:'Space Mono',monospace; color:var(--sub); margin-top:3px; opacity:.6; }

/* TOAST */
.toast {
  position:fixed; bottom:28px; left:50%;
  transform:translateX(-50%) translateY(80px);
  background:var(--accent); color:#fff; padding:11px 22px;
  border-radius:40px; font-family:'Space Mono',monospace; font-size:13px; font-weight:700;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1); z-index:200; pointer-events:none;
}
.toast.show { transform:translateX(-50%) translateY(0); }
.empty { text-align:center; padding:50px 20px; color:var(--sub); font-size:13px; }
.empty .ei { font-size:38px; margin-bottom:10px; }

/* COUNTER ITEMS (Êú¨„ÉªÈõëË™å„ÉªÊò†Áîª„Éª„ÉÜ„É¨„Éì) */
.ckitem-counter {
  display:flex; align-items:center; gap:10px; padding:9px 10px;
  border-radius:9px; background:rgba(192,127,160,.05);
  border:1px solid rgba(192,127,160,.18); margin-bottom:3px;
}
.ckitem-counter .ckemoji { font-size:20px; width:28px; text-align:center; flex-shrink:0; }
.ckitem-counter .cklbl { flex:1; font-size:14px; color:var(--text); }
.counter-ctrl { display:flex; align-items:center; gap:8px; flex-shrink:0; }
.counter-btn {
  width:30px; height:30px; border-radius:50%; border:1px solid rgba(192,127,160,.3);
  background:rgba(192,127,160,.1); color:var(--text); font-size:18px; line-height:1;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all .15s; flex-shrink:0;
}
.counter-btn:hover { background:var(--accent); border-color:var(--accent); color:#fff; }
.counter-val {
  font-family:'Space Mono',monospace; font-size:16px; font-weight:700;
  min-width:24px; text-align:center; color:var(--text);
  transition:color .15s;
}
.counter-val.has-val { color:var(--accent); font-weight:700; }

</style>
</head>
<body>

<nav>
  <button class="active" onclick="showPage('today',this)">üìù Ë®òÈå≤</button>
  <button onclick="showPage('graph',this)">üìà „Ç∞„É©„Éï</button>
  <button onclick="showPage('stamp',this)">üèÖ „Çπ„Çø„É≥„Éó</button>
  <button onclick="showPage('history',this)">üìÖ Â±•Ê≠¥</button>
</nav>

<!-- RECORD PAGE -->
<div class="page active" id="page-today">
  <div class="hdr"><h1>MOOD</h1><div class="sub" id="hdr-date"></div></div>
  <div style="height:18px"></div>

  <div class="card">
    <div class="slbl">Êó•‰ªò</div>
    <div class="dpick">
      <button class="dbtn active" id="btn-today" onclick="selDate('today')">‰ªäÊó•</button>
      <button class="dbtn" id="btn-yesterday" onclick="selDate('yesterday')">Êò®Êó•</button>
      <input type="date" class="dnative" id="date-custom" onchange="selDate('custom')">
    </div>
    <div class="dsel" id="dsel-label"></div>
  </div>

  <div class="card">
    <div class="slbl">Ê∞óÂàÜ„Çπ„Ç≥„Ç¢</div>
    <div class="mdisp">
      <div class="mval" id="mval">0</div>
      <div class="mlbl" id="mlbl">„Åµ„Å§„ÅÜ</div>
    </div>
    <div class="mtrack" id="mtrack"><div class="mthumb" id="mthumb">0</div></div>
    <div class="slabels"><span>-10 „Åó„Çì„Å©„ÅÑ</span><span>0</span><span>+10 „Éè„Ç§</span></div>
  </div>

  <div class="card">
    <div class="slbl">‰∏ÄË®Ä„É°„É¢</div>
    <textarea class="notefield" id="note-input" placeholder="‰ªäÊó•„ÅÆÊ∞óÊåÅ„Å°„Çí‰∏ÄË®Ä..."></textarea>
  </div>

  <div class="card">
    <div class="slbl">„ÇÑ„Å£„Åü„Åì„Å®</div>
    <div class="cklist" id="cklist"></div>
    <div class="ckadd">
      <input class="ckaddinput" id="ck-add-input" placeholder="ÁµµÊñáÂ≠ó+ÂêçÂâç„ÅßËøΩÂä†Ôºà‰æã: üé® Áµµ„ÇíÊèè„ÅèÔºâ">
      <button class="ckaddbtn" onclick="addCustomItem()">Ôºã</button>
    </div>
  </div>

  <button class="savebtn" onclick="saveEntry()">‚úì ‰øùÂ≠ò„Åô„Çã</button>
  <div style="height:40px"></div>
</div>

<!-- STAMP PAGE -->
<div class="page" id="page-stamp">
  <div class="hdr"><h1>üèÖ</h1><div class="sub">„Çπ„Çø„É≥„Éó„Ç´„Éº„Éâ</div></div>
  <div style="height:18px"></div>

  <!-- current card -->
  <div class="card" id="stamp-current-card">
    <div class="stamp-header-row">
      <div>
        <div class="stamp-card-label" id="stamp-card-title">„Ç´„Éº„Éâ #1</div>
        <div class="stamp-card-sub" id="stamp-card-sub"></div>
      </div>
      <div class="stamp-progress" id="stamp-progress"></div>
    </div>
    <div class="stamp-grid" id="stamp-grid"></div>
    <div class="stamp-row-labels" id="stamp-row-labels"></div>
  </div>

  <!-- past cards -->
  <div class="card" id="past-cards-section" style="display:none">
    <div class="slbl">ÈÅéÂéª„ÅÆ„Ç´„Éº„Éâ</div>
    <div class="past-card-list" id="past-card-list"></div>
  </div>

  <div style="height:40px"></div>
</div>

<!-- GRAPH PAGE -->
<div class="page" id="page-graph">
  <div class="hdr"><h1>„Ç∞„É©„Éï</h1><div class="sub" id="graph-range"></div></div>
  <div style="height:18px"></div>
  <div class="period-btns">
    <button class="pbtn active" onclick="setPeriod(7,this)">7Êó•</button>
    <button class="pbtn" onclick="setPeriod(14,this)">14Êó•</button>
    <button class="pbtn" onclick="setPeriod(30,this)">30Êó•</button>
  </div>
  <div class="stats-grid">
    <div class="stat-card"><span class="stat-val" id="stat-avg">‚Äî</span><div class="stat-desc">Âπ≥Âùá„Çπ„Ç≥„Ç¢</div></div>
    <div class="stat-card"><span class="stat-val" id="stat-days">‚Äî</span><div class="stat-desc">Ë®òÈå≤Êó•Êï∞</div></div>
  </div>
  <div class="gcontainer">
    <div class="canvas-wrap" id="canvas-wrap">
      <canvas id="moodChart"></canvas>
      <div id="chart-tooltip"></div>
    </div>
  </div>
  <div class="gcontainer">
    <div class="slbl" style="margin-bottom:12px">„Çπ„Ç≥„Ç¢ÂàÜÂ∏É</div>
    <div id="dist-bars"></div>
  </div>
  <div style="height:40px"></div>
</div>

<!-- HISTORY PAGE -->
<div class="page" id="page-history">
  <div class="hdr"><h1>Â±•Ê≠¥</h1><div class="sub">„Çø„ÉÉ„Éó„ÅßÁ∑®ÈõÜ</div></div>
  <div style="height:18px"></div>
  <div class="hlist" id="hlist"></div>
  <div style="height:40px"></div>
</div>

<!-- MODAL for past card -->
<div class="modal-backdrop" id="modal" style="display:none" onclick="closeModal(event)">
  <div class="modal" id="modal-inner">
    <div class="stamp-header-row">
      <div>
        <div class="stamp-card-label" id="modal-title"></div>
        <div class="stamp-card-sub" id="modal-sub"></div>
      </div>
      <div class="stamp-progress" id="modal-progress"></div>
    </div>
    <div class="stamp-grid" id="modal-grid"></div>
    <div class="stamp-row-labels" id="modal-row-labels"></div>
    <button class="modal-close" onclick="document.getElementById('modal').style.display='none'">Èñâ„Åò„Çã</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== CONSTANTS =====
const JP_DAYS = ['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];
const LABELS = {
  '-10':'Â∫ï„Å´„ÅÑ„Çã','-9':'„Å®„Å¶„ÇÇÈáç„ÅÑ','-8':'Âãï„Åë„Å™„ÅÑ','-7':'‰Ωï„ÇÇ„Åß„Åç„Å™„ÅÑ',
  '-6':'Âãï„Åè„ÅÆ„Åå„Å§„Çâ„ÅÑ','-5':'„Åã„Å™„Çä„Åó„Çì„Å©„ÅÑ','-4':'„Åó„Çì„Å©„ÅÑ','-3':'Ê∞óÂàÜ„ÅåÊ≤à„Çì„Åß„Çã',
  '-2':'„Å°„Çá„Å£„Å®Èáç„Åü„ÅÑ','-1':'Â∞ë„Åó„É¢„É§„É¢„É§','0':'„Åµ„Å§„ÅÜ','1':'Â∞ë„Åó‰∏äÂêë„Åç',
  '2':'„Åæ„ÅÇ„Åæ„ÅÇËâØ„ÅÑ','3':'Á©è„ÇÑ„Åã„Å´ÂÖÉÊ∞ó','4':'„Å°„Çá„Å£„Å®„É´„É≥„É´„É≥','5':'‰∏ä„Åå„ÇäÊ∞óÂë≥',
  '6':'„Åç„Çâ„Åç„ÇâÊúü','7':'Âπ∏„ÅõÊúü','8':'‰∏áËÉΩÊÑü','9':'„ÇÇ„ÅÜ„Åô„ÅêMAXË∫Å','10':'Ê≠¢„Åæ„Çå„Å™„ÅÑ'
};
const ZONES = [
  { lo:8,  hi:10, bg:'rgba(255,78,42,0.12)',   lc:'#ff4e2a', label:'Ë∫Å' },
  { lo:0,  hi:7,  bg:'rgba(245,197,66,0.09)',  lc:'#f5c542', label:'ÁõÆÊåá„Åó„Åü„ÅÑ' },
  { lo:-3, hi:-1, bg:'rgba(167,169,190,0.09)', lc:'#a7a9be', label:'ËêΩ„Å°Ëæº„Åø„Åã„Åë' },
  { lo:-7, hi:-4, bg:'rgba(107,140,186,0.12)', lc:'#6b8cba', label:'„Å©„Çì„Çà„Çä' },
  { lo:-10,hi:-8, bg:'rgba(61,169,252,0.14)',  lc:'#3da9fc', label:'È¨±' },
];
function zoneOf(v){ for(const z of ZONES) if(v>=z.lo&&v<=z.hi) return z; return {lc:'#a7a9be',label:''}; }
function zoneColor(v){ return zoneOf(v).lc; }
const DEFAULT_ITEMS = [
  {label:'Êú¨„ÇíË™≠„ÇÄ',      emoji:'üìö', counter:true},
  {label:'ÈõëË™å„ÇíË™≠„ÇÄ',    emoji:'üìò', counter:true},
  {label:'„ÉÜ„É¨„Éì„ÇíË¶ã„Çã',  emoji:'üì∫', counter:true},
  {label:'Êò†Áîª„ÇíË¶≥„Çã',    emoji:'üçø', counter:true},
  {label:'ÊñôÁêÜ„Çí‰Ωú„Çã',    emoji:'ü•ó'},
  {label:'Â∏ÉÂõ£„ÇíÂπ≤„Åô',    emoji:'üêë'},
  {label:'Ê¥óÊøØÊ©ü„ÇíÂõû„Åô',  emoji:'üëö'},
  {label:'ÊéÉÈô§„Çí„Åô„Çã',    emoji:'ü™£'},
  {label:'Ëã±Ë™û„ÅÆÂãâÂº∑„Çí„Åô„Çã',emoji:'üî§'},
  {label:'„ÉÄ„Ç§„Ç®„ÉÉ„Éà',    emoji:'üßòüèª‚Äç‚ôÄÔ∏è'},
  {label:'„Åä„Åï„Çì„ÅΩ',      emoji:'üë£'},
];

// ===== STORAGE =====
function getEntries(){ try{return JSON.parse(localStorage.getItem('mood_entries')||'[]');}catch(e){return[];} }
function saveEntries(e){ localStorage.setItem('mood_entries',JSON.stringify(e)); }
function getCustomItems(){
  try{
    const raw = JSON.parse(localStorage.getItem('mood_customs')||'[]');
    return raw.map(r=>typeof r==='string'?{label:r,emoji:'‚≠ê'}:r);
  }catch(e){return[];}
}
function saveCustomItems(a){ localStorage.setItem('mood_customs',JSON.stringify(a)); }
function getAllItems(){ return [...DEFAULT_ITEMS,...getCustomItems()]; }
function getItemEmoji(label){
  const f=getAllItems().find(i=>i.label===label);
  return f?f.emoji:'‚≠ê';
}
function getStampCards(){ try{return JSON.parse(localStorage.getItem('stamp_cards')||'[]');}catch(e){return[];} }
function saveStampCards(c){ localStorage.setItem('stamp_cards',JSON.stringify(c)); }

// ===== DATE UTILS =====
function isoToday(){ return new Date().toISOString().slice(0,10); }
function isoYesterday(){ const d=new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }
function fmtJP(iso){ const d=new Date(iso+'T00:00:00'); return `${d.getFullYear()}Âπ¥${d.getMonth()+1}Êúà${d.getDate()}Êó•Ôºà${JP_DAYS[d.getDay()]}Ôºâ`; }
function fmtShort(iso){ const d=new Date(iso+'T00:00:00'); return `${d.getMonth()+1}/${d.getDate()}`; }

// ===== GLOBAL STATE =====
let currentMood=0, selectedDate, chartPeriod=7;
let mtrack, mthumb, mvalEl, mlblEl;
let dragging=false;

// ===== ALL INIT DEFERRED TO LOAD =====
window.addEventListener('load', function() {
  selectedDate = isoToday();
  // Reset page visibility to CSS-controlled
  document.querySelectorAll('.page').forEach(p=>{ p.style.display=''; });

  // grab DOM refs
  mtrack = document.getElementById('mtrack');
  mthumb = document.getElementById('mthumb');
  mvalEl = document.getElementById('mval');
  mlblEl = document.getElementById('mlbl');

  document.getElementById('hdr-date').textContent = fmtJP(isoToday());
  document.getElementById('date-custom').max = isoToday();
  updateDsel();
  loadEntryForDate(selectedDate);
  renderChecklist([]);

  // slider events
  mtrack.addEventListener('mousedown',  e=>{dragging=true;setMoodUI(moodFromX(e.clientX));});
  mtrack.addEventListener('touchstart', e=>{dragging=true;setMoodUI(moodFromX(e.touches[0].clientX));},{passive:true});
  document.addEventListener('mousemove',  e=>{if(dragging)setMoodUI(moodFromX(e.clientX));});
  document.addEventListener('touchmove',  e=>{if(dragging)setMoodUI(moodFromX(e.touches[0].clientX));},{passive:true});
  document.addEventListener('mouseup',  ()=>dragging=false);
  document.addEventListener('touchend', ()=>dragging=false);

  // enter key for checklist
  document.getElementById('ck-add-input').addEventListener('keydown',e=>{if(e.key==='Enter')addCustomItem();});
});

// ===== DATE PICKER =====
function selDate(which){
  document.getElementById('btn-today').classList.remove('active');
  document.getElementById('btn-yesterday').classList.remove('active');
  if(which==='today'){
    selectedDate=isoToday();
    document.getElementById('btn-today').classList.add('active');
    document.getElementById('date-custom').value='';
  } else if(which==='yesterday'){
    selectedDate=isoYesterday();
    document.getElementById('btn-yesterday').classList.add('active');
    document.getElementById('date-custom').value='';
  } else {
    const v=document.getElementById('date-custom').value;
    if(!v) return;
    selectedDate=v;
  }
  updateDsel();
  loadEntryForDate(selectedDate);
}
function updateDsel(){ document.getElementById('dsel-label').textContent=fmtJP(selectedDate); }
function loadEntryForDate(key){
  const e=getEntries().find(e=>e.date===key);
  setMoodUI(e?e.mood:0);
  document.getElementById('note-input').value=e?(e.note||''):'';
  renderChecklist(e?(e.checked||[]):[]);
}

// ===== SLIDER =====
function setMoodUI(v){
  currentMood=v;
  if(!mtrack) return;
  const pct=(v+10)/20;
  mthumb.style.left=(pct*mtrack.offsetWidth)+'px';
  const d=v>0?'+'+v:String(v);
  mthumb.textContent=d; mvalEl.textContent=d;
  mvalEl.style.color=zoneColor(v);
  mlblEl.textContent=LABELS[String(v)]||'';
}
function moodFromX(cx){
  const r=mtrack.getBoundingClientRect();
  return Math.round(Math.max(0,Math.min(1,(cx-r.left)/r.width))*20-10);
}

// ===== CHECKLIST =====
function renderChecklist(checked){
  // checked: array of label strings (for bool items) OR {label, count} objects (for counter items)
  checked = checked || [];
  const el=document.getElementById('cklist');
  if(!el) return;
  el.innerHTML='';

  function getCount(label) {
    const found = checked.find(c => (typeof c === 'object' ? c.label : c) === label);
    if(!found) return 0;
    return typeof found === 'object' ? (found.count||0) : 1;
  }
  function isChecked(label) {
    return checked.some(c => (typeof c === 'object' ? c.label : c) === label);
  }

  getAllItems().forEach((item,idx)=>{
    const isCustom=idx>=DEFAULT_ITEMS.length;
    const safeLabel=item.label.replace(/"/g,'&quot;');

    if(item.counter) {
      // Counter-type item
      const count = getCount(item.label);
      const div=document.createElement('div');
      div.className='ckitem-counter';
      div.dataset.label=item.label;
      div.innerHTML=`
        <span class="ckemoji">${item.emoji}</span>
        <span class="cklbl">${item.label}</span>
        <div class="counter-ctrl">
          <button class="counter-btn" data-action="dec" data-label="${safeLabel}">‚àí</button>
          <span class="counter-val${count>0?' has-val':''}" data-counter="${safeLabel}">${count}</span>
          <button class="counter-btn" data-action="inc" data-label="${safeLabel}">Ôºã</button>
        </div>
      `;
      div.addEventListener('click', function(e){
        const btn = e.target.closest('.counter-btn');
        if(!btn) return;
        const action = btn.dataset.action;
        const lbl = btn.dataset.label;
        const valEl = div.querySelector('.counter-val');
        let cur = parseInt(valEl.textContent)||0;
        if(action==='inc') cur++;
        else if(action==='dec') cur=Math.max(0,cur-1);
        valEl.textContent=cur;
        valEl.className='counter-val'+(cur>0?' has-val':'');
      });
      el.appendChild(div);
    } else {
      // Boolean toggle item
      const on=isChecked(item.label);
      const div=document.createElement('div');
      div.className='ckitem'+(on?' on':'');
      div.dataset.label=item.label;
      div.innerHTML=`
        <span class="ckemoji">${item.emoji}</span>
        <div class="ckbox">${on?'‚úì':''}</div>
        <span class="cklbl">${item.label}</span>
        ${isCustom?`<button class="ckdel" data-lbl="${safeLabel}">√ó</button>`:''}
      `;
      div.addEventListener('click',function(e){
        if(e.target.classList.contains('ckdel')){
          const t=e.target.dataset.lbl;
          saveCustomItems(getCustomItems().filter(c=>c.label!==t));
          renderChecklist(getCheckedData().filter(c=>(typeof c==='object'?c.label:c)!==t));
          return;
        }
        this.classList.toggle('on');
        this.querySelector('.ckbox').textContent=this.classList.contains('on')?'‚úì':'';
      });
      el.appendChild(div);
    }
  });
}
// Returns array of: string (for bool items) or {label, count} (for counter items)
function getCheckedData(){
  const result = [];
  // counter items
  document.querySelectorAll('#cklist .ckitem-counter').forEach(div=>{
    const count = parseInt(div.querySelector('.counter-val').textContent)||0;
    if(count>0) result.push({label:div.dataset.label, count});
  });
  // bool items
  document.querySelectorAll('#cklist .ckitem.on').forEach(div=>{
    result.push(div.dataset.label);
  });
  return result;
}
// For backward compat: flat list of labels that are "active"
function getCheckedLabels(){
  return getCheckedData().map(c=>typeof c==='object'?c.label:c);
}
function addCustomItem(){
  const inp=document.getElementById('ck-add-input');
  const raw=inp.value.trim(); if(!raw) return;
  const m=raw.match(/^(\p{Emoji_Presentation}|\p{Extended_Pictographic})\s*/u);
  let emoji='‚≠ê',label=raw;
  if(m){emoji=m[1];label=raw.slice(m[0].length).trim();}
  if(!label) return;
  const customs=getCustomItems();
  if(getAllItems().some(i=>i.label===label)){inp.value='';return;}
  customs.push({label,emoji});
  saveCustomItems(customs);
  inp.value='';
  renderChecklist(getCheckedLabels());
}

// ===== SAVE =====
function saveEntry(){
  const checked=getCheckedData();
  const entries=getEntries();
  const idx=entries.findIndex(e=>e.date===selectedDate);
  const entry={date:selectedDate,mood:currentMood,note:document.getElementById('note-input').value.trim(),checked};
  addStampsForEntry(selectedDate, checked, idx>=0?(entries[idx].checked||[]):null);
  if(idx>=0) entries[idx]=entry;
  else{ entries.push(entry); entries.sort((a,b)=>b.date.localeCompare(a.date)); }
  saveEntries(entries);
  showToast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úì');
}

// ===== STAMP CARD LOGIC =====
function addStampsForEntry(date, checkedData, prevCheckedData){
  let cards = getStampCards();
  // Remove all stamps for this date (full recalc on re-save)
  cards.forEach(card=>{ card.stamps = card.stamps.filter(s=>s.date!==date); });
  while(cards.length>1 && cards[cards.length-2].stamps.length===0) cards.splice(-2,1);
  if(cards.length===0) cards=[{id:1,stamps:[],startDate:date}];

  // Build list of stamps to add: counter items add N stamps, bool items add 1
  const stampsToAdd = [];
  (checkedData||[]).forEach(c=>{
    if(typeof c==='object'){
      const {label,count} = c;
      const emoji = getItemEmoji(label);
      for(let i=0;i<count;i++) stampsToAdd.push({label,emoji,date});
    } else {
      stampsToAdd.push({label:c, emoji:getItemEmoji(c), date});
    }
  });

  stampsToAdd.forEach(stamp=>{
    let placed=false;
    for(const card of cards){
      if(card.stamps.length<100){ card.stamps.push(stamp); placed=true; break; }
    }
    if(!placed){
      const newId=(cards[cards.length-1].id||cards.length)+1;
      cards[cards.length-1].endDate=date;
      cards.push({id:newId,stamps:[stamp],startDate:date});
    }
  });
  saveStampCards(cards);
}

function renderStampPage(){
  const gridEl = document.getElementById('stamp-grid');
  if(!gridEl) return;
  const cards=getStampCards();
  if(cards.length===0){
    renderStampGridInto('stamp-grid','stamp-row-labels',[]);
    document.getElementById('stamp-card-title').textContent='„Ç´„Éº„Éâ #1';
    document.getElementById('stamp-card-sub').textContent='„ÉÅ„Çß„ÉÉ„ÇØ„Çí‰øùÂ≠ò„Åô„Çã„Å®„Çπ„Çø„É≥„Éó„ÅåË≤Ø„Åæ„Çä„Åæ„Åô';
    document.getElementById('stamp-progress').textContent='0 / 100';
    document.getElementById('past-cards-section').style.display='none';
    return;
  }
  const current=cards[cards.length-1];
  document.getElementById('stamp-card-title').textContent=`„Ç´„Éº„Éâ #${current.id||cards.length}`;
  document.getElementById('stamp-card-sub').textContent=`${fmtShort(current.startDate)} „Äú`;
  document.getElementById('stamp-progress').textContent=`${current.stamps.length} / 100`;
  renderStampGridInto('stamp-grid','stamp-row-labels',current.stamps);
  const past=cards.slice(0,-1);
  const sec=document.getElementById('past-cards-section');
  if(past.length===0){sec.style.display='none';return;}
  sec.style.display='block';
  const list=document.getElementById('past-card-list');
  list.innerHTML='';
  past.slice().reverse().forEach((card,ri)=>{
    const realIdx=past.length-1-ri;
    const div=document.createElement('div');
    div.className='past-card-item';
    const preview=card.stamps.slice(0,20).map(s=>s.emoji).join('');
    div.innerHTML=`
      <div class="past-card-title">„Ç´„Éº„Éâ #${card.id||realIdx+1}</div>
      <div class="past-card-meta">${fmtShort(card.startDate)} „Äú ${card.endDate?fmtShort(card.endDate):'?'} Ôºè 100„Çπ„Çø„É≥„Éó</div>
      <div class="past-card-preview">${preview}${card.stamps.length>20?'‚Ä¶':''}</div>
    `;
    div.onclick=()=>openPastCard(card,realIdx+1);
    list.appendChild(div);
  });
}
function renderStampGridInto(gridId, labelsId, stamps){
  const grid=document.getElementById(gridId);
  const labelsEl=document.getElementById(labelsId);
  grid.innerHTML='';
  if(labelsEl) labelsEl.innerHTML=''; // keep element but clear it (unused now)
  for(let i=0;i<100;i++){
    const num=i+1;
    const isMilestone=(num%10===0);
    const cell=document.createElement('div');
    const classes=['stamp-cell'];
    if(stamps[i]) classes.push('filled');
    if(isMilestone) classes.push('milestone');
    cell.className=classes.join(' ');
    if(isMilestone) cell.dataset.num=String(num);
    if(stamps[i]) cell.textContent=stamps[i].emoji;
    grid.appendChild(cell);
  }
}
function openPastCard(card,num){
  document.getElementById('modal-title').textContent=`„Ç´„Éº„Éâ #${num}`;
  document.getElementById('modal-sub').textContent=`${fmtShort(card.startDate)} „Äú ${card.endDate?fmtShort(card.endDate):'?'}`;
  document.getElementById('modal-progress').textContent=`${card.stamps.length} / 100`;
  renderStampGridInto('modal-grid','modal-row-labels',card.stamps);
  document.getElementById('modal').style.display='flex';
}
function closeModal(e){
  if(e.target.id==='modal') document.getElementById('modal').style.display='none';
}

// ===== NAV =====
function showPage(name,btn){
  // Hide all pages
  var pages = document.querySelectorAll('.page');
  for(var i=0;i<pages.length;i++) pages[i].style.display='none';
  // Show target page
  var target = document.getElementById('page-'+name);
  if(target) target.style.display='block';
  // Update nav buttons
  var btns = document.querySelectorAll('nav button');
  for(var i=0;i<btns.length;i++) btns[i].classList.remove('active');
  btn.classList.add('active');
  // Render page content
  try {
    if(name==='stamp')   renderStampPage();
    else if(name==='graph')   renderGraph();
    else if(name==='history') renderHistory();
  } catch(err) { console.error('renderError:', err); }
}

// ===== GRAPH =====
function setPeriod(days,btn){
  chartPeriod=days;
  document.querySelectorAll('.pbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderGraph();
}
function renderGraph(){
  const entries=getEntries(), dateMap={};
  entries.forEach(e=>dateMap[e.date]=e);
  const labels=[],fullLabels=[],moodData=[];
  for(let i=chartPeriod-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const key=d.toISOString().slice(0,10);
    labels.push(fmtShort(key)); fullLabels.push(fmtJP(key));
    moodData.push(dateMap[key]!==undefined?dateMap[key].mood:null);
  }
  const valid=moodData.filter(v=>v!==null);
  document.getElementById('stat-avg').textContent=valid.length?(valid.reduce((a,b)=>a+b,0)/valid.length).toFixed(1):'‚Äî';
  document.getElementById('stat-days').textContent=valid.length||'‚Äî';
  document.getElementById('graph-range').textContent=`Áõ¥Ëøë${chartPeriod}Êó•Èñì`;
  drawChart(labels,fullLabels,moodData);
  drawDistBars(valid);
}
function drawChart(labels,fullLabels,moodData){
  const canvas=document.getElementById('moodChart');
  const wrap=document.getElementById('canvas-wrap');
  const dpr=window.devicePixelRatio||1;
  const cssW=Math.max(wrap.clientWidth||300, 100), cssH=250;
  canvas.style.width=cssW+'px'; canvas.style.height=cssH+'px';
  canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr);
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const W=cssW,H=cssH,PAD={t:18,r:14,b:34,l:38};
  const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
  ctx.fillStyle='#faf7f9';
  ctx.fillRect(0,0,W,H);
  ctx.clearRect(0,0,W,H);
  function yFor(v){return PAD.t+cH*(1-(v+10)/20);}
  ZONES.forEach(z=>{
    ctx.fillStyle=z.bg;
    ctx.fillRect(PAD.l,yFor(z.hi+.5),cW,yFor(z.lo-.5)-yFor(z.hi+.5));
    ctx.save(); ctx.fillStyle=z.lc+'99';
    ctx.font="10px 'Noto Sans JP',sans-serif"; ctx.textAlign='right';
    ctx.fillText(z.label,PAD.l+cW-3,yFor(z.hi+.5)+12); ctx.restore();
  });
  [-10,-5,0,5,10].forEach(v=>{
    const y=yFor(v);
    ctx.save(); ctx.strokeStyle=v===0?'rgba(192,127,160,.4)':'rgba(192,127,160,.15)';
    ctx.lineWidth=v===0?1:.75; if(v===0)ctx.setLineDash([5,5]);
    ctx.beginPath();ctx.moveTo(PAD.l,y);ctx.lineTo(PAD.l+cW,y);ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(90,70,90,.5)'; ctx.font="9px 'Space Mono',monospace"; ctx.textAlign='right';
    ctx.fillText(v>0?'+'+v:String(v),PAD.l-5,y+3.5); ctx.restore();
  });
  const step=cW/Math.max(labels.length-1,1);
  const pts=moodData.map((v,i)=>v!==null?[PAD.l+i*step,yFor(v)]:null);
  ctx.lineWidth=2.5; ctx.lineJoin='round'; ctx.lineCap='round';
  for(let i=0;i<pts.length-1;i++){
    const p1=pts[i],p2=pts[i+1]; if(!p1||!p2)continue;
    const g=ctx.createLinearGradient(p1[0],0,p2[0],0);
    g.addColorStop(0,zoneColor(moodData[i])); g.addColorStop(1,zoneColor(moodData[i+1]));
    ctx.strokeStyle=g; ctx.beginPath(); ctx.moveTo(p1[0],p1[1]); ctx.lineTo(p2[0],p2[1]); ctx.stroke();
  }
  pts.forEach((p,i)=>{
    if(!p)return;
    ctx.beginPath(); ctx.arc(p[0],p[1],4.5,0,Math.PI*2);
    ctx.fillStyle=zoneColor(moodData[i]); ctx.fill();
    ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; ctx.stroke();
  });
  const interval=labels.length<=7?1:labels.length<=14?2:Math.ceil(labels.length/10);
  ctx.fillStyle='rgba(90,70,90,.5)'; ctx.font="9px 'Space Mono',monospace"; ctx.textAlign='center';
  labels.forEach((lbl,i)=>{ const x=PAD.l+i*step; if(i%interval===0||i===labels.length-1)ctx.fillText(lbl,x,H-8); });
  const tip=document.getElementById('chart-tooltip');
  if(canvas._onMove) canvas.removeEventListener('mousemove',canvas._onMove);
  if(canvas._onLeave) canvas.removeEventListener('mouseleave',canvas._onLeave);
  canvas._onMove=function(e){
    const rect=canvas.getBoundingClientRect(), mx=e.clientX-rect.left;
    let closest=null,minD=Infinity;
    pts.forEach((p,i)=>{if(!p)return;const d=Math.abs(p[0]-mx);if(d<minD){minD=d;closest=i;}});
    if(closest!==null&&pts[closest]&&minD<32){
      const v=moodData[closest],col=zoneColor(v),disp=v>0?'+'+v:String(v);
      tip.style.display='block';
      tip.style.left=Math.max(50,Math.min(pts[closest][0],cssW-50))+'px';
      tip.style.top=(pts[closest][1]-62)+'px';
      tip.innerHTML=`<div style="font-size:10px;color:rgba(90,70,90,.55);margin-bottom:2px;font-family:'Space Mono',monospace">${fullLabels[closest]}</div><div style="font-family:'DM Serif Display',serif;font-size:20px;color:${col}">${disp} <span style="font-size:11px;color:rgba(90,70,90,.7);font-family:'Noto Sans JP',sans-serif">${LABELS[String(v)]||''}</span></div>`;
    } else tip.style.display='none';
  };
  canvas._onLeave=()=>{tip.style.display='none';};
  canvas.addEventListener('mousemove',canvas._onMove);
  canvas.addEventListener('mouseleave',canvas._onLeave);
}
function drawDistBars(valid){
  const counts=Array(21).fill(0);
  valid.forEach(v=>counts[v+10]++);
  const mx=Math.max(...counts,1);
  const el=document.getElementById('dist-bars'); el.innerHTML='';
  for(let v=10;v>=-10;v--){
    const c=counts[v+10];
    const row=document.createElement('div'); row.className='barrow';
    row.innerHTML=`<span class="bl">${v>0?'+'+v:v}</span><div class="barbg"><div class="barfill" style="width:${c/mx*100}%;background:${zoneColor(v)}"></div></div><span class="barcnt">${c||''}</span>`;
    el.appendChild(row);
  }
}

// ===== HISTORY =====
function renderHistory(){
  const entries=getEntries();
  const list=document.getElementById('hlist');
  if(!entries.length){list.innerHTML='<div class="empty"><div class="ei">üì≠</div>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';return;}
  list.innerHTML='';
  entries.forEach(e=>{
    const v=e.mood,z=zoneOf(v),disp=v>0?'+'+v:String(v);
    const checked=e.checked||[];
    const badgeItems = checked.slice(0,5).map(c=>{
      if(typeof c==='object') {
        const cnt = Math.max(0, Math.floor(Number(c.count)||0));
        return getItemEmoji(c.label).repeat(Math.min(cnt,3))+(cnt>3?'√ó'+cnt:'');
      }
      return getItemEmoji(c);
    });
    const badges=checked.length?(badgeItems.join('')+(checked.length>5?'‚Ä¶':'')):'';
    const item=document.createElement('div'); item.className='hitem';
    item.innerHTML=`<div class="hscore" style="color:${z.lc}">${disp}</div><div class="hinfo"><div class="hdate">${fmtJP(e.date)}</div><div class="hnote">${e.note||'(„É°„É¢„Å™„Åó)'}</div><div class="hbadge">${z.label}${badges?' ¬∑ '+badges:''}</div></div>`;
    item.onclick=()=>jumpToEdit(e.date);
    list.appendChild(item);
  });
}
function jumpToEdit(key){
  selectedDate=key;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-today').classList.add('active');
  document.querySelector('nav button:first-child').classList.add('active');
  document.getElementById('btn-today').classList.remove('active');
  document.getElementById('btn-yesterday').classList.remove('active');
  if(key===isoToday()) document.getElementById('btn-today').classList.add('active');
  else if(key===isoYesterday()) document.getElementById('btn-yesterday').classList.add('active');
  else document.getElementById('date-custom').value=key;
  updateDsel(); loadEntryForDate(key);
}

// ===== TOAST =====
function showToast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}
</script>
</body>
</html>
